<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Giỏ hàng</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/Cart-page.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    {% include 'MenuBar.html' %}
    <h4 style="padding-left: 195px">Giỏ hàng của bạn</h4>

    <div class="cart-page">
    {% if cart_items %}
    <table class="cart-table">
        <tr>
            <th style="padding-left: 155px">Tên sản phẩm</th>
            <th> </th>
            <th>Giá</th>
            <th>Số lượng</th>
            <th>Thành tiền</th>
            <th>Hành động</th>
        </tr>
        {% for item in cart_items %}
        {% set dis_price = item.Gia * (100 - item.Discount) / 100 %}
        <tr>
            <td>
                <a class="product-wrapper" href="{{ url_for('product.product_detail', pid=item.MaSP) }}">
                    <img src="{{ url_for('static', filename = item.HinhAnh) }}">
                    <div class="pro-name">{{ item.TenSP }}</div>
                </a>
            </td>
            <td>
                <div class="option">
                    {{ item.MauSacDaChon }},
                    {{ item.KichCoDaChon }}
                </div>
            </td>
            <td style="color:orange"><s>{{ item.Gia|int }}₫</s> {{ dis_price|int }}₫</td>
            <td>
                <div class="qcontrol">
                    <button class="btnL"
                            id="decrease_{{ item.MaSP }}_{{ item.MauSacDaChon }}_{{ item.KichCoDaChon }}"
                            onclick="changeQuantitybtn(-1, '{{ item.MaSP }}', '{{ item.MauSacDaChon }}', '{{ item.KichCoDaChon }}')">-</button>

                    <input type="text"
                           id="quantity_{{ item.MaSP }}_{{ item.MauSacDaChon }}_{{ item.KichCoDaChon }}"
                           value="{{ item.SoLuong }}" readonly>
                    <input type="hidden"
                           id="left_{{ item.MaSP }}_{{ item.MauSacDaChon }}_{{ item.KichCoDaChon }}"
                           value="{{ item.SoLuongCon }}">

                    <button class="btnR"
                            id="increase_{{ item.MaSP }}_{{ item.MauSacDaChon }}_{{ item.KichCoDaChon }}"
                            onclick="changeQuantitybtn(1, '{{ item.MaSP }}', '{{ item.MauSacDaChon }}', '{{ item.KichCoDaChon }}')">+</button>
                </div>

            </td>
            <td style="color:orange">{{ (dis_price * item.SoLuong)|int }}₫</td>
            <td>
                <a href="{{ url_for('cart_bp.remove_from_cart',
                        maSP=item.MaSP,
                        mau=item.MauSacDaChon,
                        size=item.KichCoDaChon) }}">
                    Xóa
                </a>
            </td>
        </tr>
        {% endfor %}
    </table>

    <div class="actions">
        <h3>Tổng cộng: {{ total_price }}₫</h3>
        <a href="{{ url_for('cart_bp.clear_cart') }}">Xóa toàn bộ</a>
    </div>
    {% else %}
    <p style="text-align:center;">Giỏ hàng trống.</p>
    {% endif %}
    </div>

    <script>
        let debounceTimeout = null;

        function changeQuantitybtn(delta, MaSP, mau, size) {
            let input = document.getElementById(`quantity_${MaSP}_${mau}_${size}`);
            let value = parseInt(input.value);
            const maxStock = parseInt(document.getElementById(`left_${MaSP}_${mau}_${size}`).value);
            value += delta;
            if (value < 1) value = 1;
            if (value > maxStock) value = maxStock;
            input.value = value;
            document.getElementById(`decrease_${MaSP}_${mau}_${size}`).disabled = (value === 1);
            document.getElementById(`increase_${MaSP}_${mau}_${size}`).disabled = (value === maxStock);

            // Debounce gửi request
            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(() => {
                updateCart(MaSP, mau, size, value);
            }, 500); // 500ms sau lần bấm cuối mới gửi

        }

        function updateCart(MaSP, mau, size, quantity) {
            fetch('/update-cart', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({MaSP: MaSP, MauSacDaChon: mau, KichCoDaChon: size, SoLuong: quantity})
            })
                .then(res => res.json())
                .then(data => console.log(data));
        }
    </script>
</body>
</html>

