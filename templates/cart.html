<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Giỏ hàng</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/Cart-page.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    {% include 'MenuBar.html' %}
    <h4 style="padding-left: 195px">Giỏ hàng của bạn</h4>

    <div class="cart-page">
    {% if cart_items %}
    <table class="cart-table">
        <tr>
            <th></th>
            <th style="padding-left: 155px">Tên sản phẩm</th>
            <th> </th>
            <th>Giá</th>
            <th>Số lượng</th>
            <th>Thành tiền</th>
            <th>Hành động</th>
        </tr>
        {% for item in cart_items %}
        {% set dis_price = item.Gia * (100 - item.Discount) / 100 %}
        <tr>
            <td class="checksum">
                <input type="checkbox"
                    class="cart-checkbox"
                    data-id="{{ item.MaSP }}"
                    data-color="{{ item.MauSacDaChon }}"
                    data-size="{{ item.KichCoDaChon }}"
                    data-price="{{ dis_price }}"
                    data-quantity="{{ item.SoLuong }}">
            </td>
            <td>
                <a class="product-wrapper" href="{{ url_for('product.product_detail', pid=item.MaSP) }}">
                    {% set selected_color = (item.colors | selectattr('name', 'equalto', item.MauSacDaChon) | list | first) %}
                    <img src="{{ url_for('static', filename = selected_color.image if selected_color.image else 'images/default.jpg') }}">
                    <div class="pro-name">{{ item.TenSP }}</div>
                </a>
            </td>
            <td>
                <div class="option">
                    <button class="optionBtn"
                            data-target="dropdown_{{ item.MaSP }}_{{ item.MauSacDaChon }}_{{ item.KichCoDaChon }}">
                        {{ item.MauSacDaChon }}, {{ item.KichCoDaChon }}
                        <span class="triangle-down"></span>
                    </button>
                    <div id="dropdown_{{ item.MaSP }}_{{ item.MauSacDaChon }}_{{ item.KichCoDaChon }}" class="dropdown">
                        <span class="triangle"></span>
                        <form id="form_{{ item.MaSP }}_{{ item.MauSacDaChon }}_{{ item.KichCoDaChon }}">
                            Màu sắc:
                            {% for c in item.colors %}
                            <label class="container">
                                <input type="radio" name="color" value="{{ c.name }}"/>
                                <span class="text">{{ c.name }}</span>
                            </label>
                            {% endfor %}
                            <br>
                            Size:
                            {% for s in item.sizes %}
                            <label class="container">
                                <input type="radio" name="size" value="{{ s }}"/>
                                <span class="text">{{ s }}</span>
                            </label>
                            {% endfor %}
                            <div class="cart-form-options">
                                <button type="reset">Hủy</button>
                                <button type="submit"
                                        onclick="updateCartOption('{{ item.MaSP }}', '{{ item.MauSacDaChon }}', '{{ item.KichCoDaChon }}')">
                                    Xác nhận
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </td>
            <td style="color:orange"><s>{{ item.Gia|vnd }}</s> {{ dis_price|vnd }}</td>
            <td>
                <div class="qcontrol">
                    <button class="btnL"
                            id="decrease_{{ item.MaSP }}_{{ item.MauSacDaChon }}_{{ item.KichCoDaChon }}"
                    >-</button>

                    <input type="text"
                           id="quantity_{{ item.MaSP }}_{{ item.MauSacDaChon }}_{{ item.KichCoDaChon }}"
                           value="{{ item.SoLuong }}" readonly>
                    <input type="hidden"
                           id="left_{{ item.MaSP }}_{{ item.MauSacDaChon }}_{{ item.KichCoDaChon }}"
                           value="{{ item.SoLuongCon }}">

                    <button class="btnR"
                            id="increase_{{ item.MaSP }}_{{ item.MauSacDaChon }}_{{ item.KichCoDaChon }}"
                    >+</button>
                </div>
            </td>
            <td style="color:orange">{{ (dis_price * item.SoLuong)|vnd }}</td>
            <td>
                <a href="{{ url_for('cart_bp.remove_from_cart',
                        maSP=item.MaSP,
                        mau=item.MauSacDaChon,
                        size=item.KichCoDaChon) }}">
                    Xóa
                </a>
            </td>
        </tr>
        {% endfor %}
    </table>

    <div class="actions">
        <h3>Tổng cộng: {{ total_price|vnd }}</h3>
        <a href="{{ url_for('cart_bp.clear_cart') }}">Xóa toàn bộ</a>
    </div>
    {% else %}
    <p style="text-align:center;">Giỏ hàng trống.</p>
    {% endif %}
    </div>

    <div id="cart-summary">
        <span id="selected-count">0</span> sản phẩm được chọn |
        Tổng tiền: <span id="total-price">0₫</span>
        <button id="create-order-btn">Tạo đơn hàng</button>
    </div>

    <!-- script đổi số lượng sản phẩm -->
    <script>
        const debounceTimeouts = {};

        document.querySelectorAll('.btnL, .btnR').forEach(btn => {
            btn.addEventListener('click', () => {
                // Lấy delta từ class
                const delta = btn.classList.contains('btnL') ? -1 : 1;

                // Lấy thông tin từ ID của button
                const parts = btn.id.split('_');
                // btn.id = "decrease_MaSP_Mau_Size" hoặc "increase_MaSP_Mau_Size"
                const MaSP = parts[1];
                const mau = parts[2];
                const size = parts[3];

                const quantityInput = document.getElementById(`quantity_${MaSP}_${mau}_${size}`);
                const maxStock = parseInt(document.getElementById(`left_${MaSP}_${mau}_${size}`).value);

                let value = parseInt(quantityInput.value);
                value += delta;
                if (value < 1) value = 1;
                if (value > maxStock) value = maxStock;
                quantityInput.value = value;

                document.getElementById(`decrease_${MaSP}_${mau}_${size}`).disabled = (value === 1);
                document.getElementById(`increase_${MaSP}_${mau}_${size}`).disabled = (value === maxStock);

                // Debounce riêng cho từng sản phẩm
                const key = `${MaSP}_${mau}_${size}`;
                clearTimeout(debounceTimeouts[key]);
                debounceTimeouts[key] = setTimeout(() => {
                    updateCart(MaSP, mau, size, value);
                }, 500);
                });
            });

        function updateCart(MaSP, mau, size, quantity) {
        fetch('/update-cart', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({MaSP: MaSP, MauSacDaChon: mau, KichCoDaChon: size, SoLuong: quantity})
        })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    location.reload();
                }
            })
            .catch(err => console.error(err));
        }
    </script>

    <!-- script đổi màu và size -->
    <script>
        document.querySelectorAll('.optionBtn').forEach(btn => {
            btn.addEventListener('click', () => {
                const targetId = btn.dataset.target;
                const dropdown = document.getElementById(targetId);
                //tắt hết dropdown khác
                document.querySelectorAll('.dropdown.active').forEach(dd => {
                    if (dd !== dropdown) dd.classList.remove('active');
                });
                dropdown.classList.toggle('active');
            });
        });

        // Gửi yêu cầu đổi màu/size sản phẩm trong giỏ
        async function updateCartOption(maSP, oldMau, oldSize) {
            const form = document.getElementById(`form_${maSP}_${oldMau}_${oldSize}`);
            const newMau = form.querySelector('input[name="color"]:checked')?.value || oldMau;
            const newSize = form.querySelector('input[name="size"]:checked')?.value || oldSize;

            // Nếu không chọn gì mới → bỏ qua
            if (newMau === oldMau && newSize === oldSize) {
                alert("Bạn chưa thay đổi màu hoặc size!");
                return;
            }

            const so_luong = document.getElementById(`quantity_${maSP}_${oldMau}_${oldSize}`).value || 1;

            try {
                const res = await fetch("/update-cart-item-option", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        old_ma_sp: maSP,
                        new_ma_sp: maSP,
                        old_mau: oldMau,
                        old_size: oldSize,
                        new_mau: newMau,
                        new_size: newSize,
                        so_luong
                    })
                });

                const data = await res.json();
                if (data.success) {
                    alert("Cập nhật giỏ hàng thành công!");
                    location.reload();
                } else if (data.error === "not_logged_in") {
                    alert("Vui lòng đăng nhập trước khi thao tác!");
                    window.location.href = "/login";
                } else {
                    alert("Lỗi khi cập nhật sản phẩm!");
                }
            } catch (err) {
                console.error(err);
                alert("Không thể kết nối server!");
            }
        }
    </script>

    <!-- script cho checkbox và order hàng -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const checkboxes = document.querySelectorAll('.cart-checkbox');
            const totalPriceEl = document.getElementById("total-price");
            const selectedCountEl = document.getElementById("selected-count");
            const createOrderBtn = document.getElementById("create-order-btn");

            // restore trạng thái từ localStorage
            const savedChecked = JSON.parse(localStorage.getItem('cartChecked') || '{}');
            checkboxes.forEach(cb => {
            const key = `${cb.dataset.id}_${cb.dataset.color}_${cb.dataset.size}`;
            if(savedChecked[key]) cb.checked = true;
            });

            function updateSummary() {
                const checkboxes = document.querySelectorAll(".cart-checkbox"); // lấy lại từ DOM
                let total = 0;
                let count = 0;

                checkboxes.forEach(cb => {
                    if(cb.checked){
                        const price = parseFloat(cb.dataset.price) || 0;
                        const quantity = parseInt(cb.dataset.quantity) || 1;
                        total += price * quantity;
                        count++;
                    }
                });

                totalPriceEl.textContent = total.toLocaleString("vi-VN") + "₫";
                selectedCountEl.textContent = count;
            }

            function saveChecked() {
                const obj = {};
                checkboxes.forEach(cb => {
                    const key = `${cb.dataset.id}_${cb.dataset.color}_${cb.dataset.size}`;
                    obj[key] = cb.checked;
                });
                localStorage.setItem('cartChecked', JSON.stringify(obj));
            }

        // các event
        checkboxes.forEach(cb => {
            cb.addEventListener("change", () => {
            saveChecked();
            updateSummary();
            });
        });

        createOrderBtn.addEventListener("click", () => {
        // Xử lý tạo đơn
        });

        // tính summary ngay khi load
        updateSummary();
        });
    </script>

</body>
</html>

