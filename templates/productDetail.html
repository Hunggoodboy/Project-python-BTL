<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>{{ product.TenSP }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/productdetail.css') }}">
</head>
<body>

{%include 'MenuBar.html'%}
<h4> &nbsp </h4>
<br>

<div class="product-detail">
    <div class="image-viewer">
        <button class="nav-btn left" onclick="prevImage()">‚ùÆ</button>
        <img id="main-image" src="{{ product.images[0] if product.images else url_for('static', filename='images/default.png') }}" alt="{{ product.TenSP }}">
        <button class="nav-btn right" onclick="nextImage()">‚ùØ</button>
    </div>

    <script id="image-data" type="application/json">
        {{ product.images | tojson | safe }}
    </script>


    <div class="price-row">
        <span class="price">{{ "{:,.0f}".format(product.Gia | default(0)) }}‚Ç´</span>
        <span class="sold">ƒê√£ b√°n: {{ product.Sold | default(0) }}</span>
    </div>

    <div class="discount">
        Gi·∫£m: {{ product.Discount | default(0) }}%
    </div>

    <h2 class="product-name">{{ product.TenSP | default("S·∫£n ph·∫©m") }}</h2>
    <input type="hidden" id="product-id" value="{{ product.MaSP }}">

    <div class="section section-box color">
        <strong>M√†u s·∫Øc:</strong>
        <div class="color-options">
            {% for color in product.colors %}
            <button
                    class="color-thumb"
                    onclick="selectColor(this); changeColor(`{{ url_for('static', filename=color.image) | default('default.png') }}`)"
            >
                {{ color.name }}
            </button>
            {% endfor %}
        </div>
    </div>
    <input type="hidden" id="selected-color" value="">

    <div class="section section-box size">
        <strong>Size:</strong>
        <div class="size-options">
            {% for s in product.sizes | default([]) %}
            <button class="size-btn" onclick="selectSize(this)">{{ s }}</button>
            {% endfor %}
        </div>
    </div>
    <input type="hidden" id="selected-size" value="">

    <div class="quantity-control">
        <span>S·ªë l∆∞·ª£ng:</span>
        <div>
            <button class="qty-btn" id="decrease1" onclick="changeQuantity1(-1)">-</button>
            <input type="text" id="quantity1" value="1" readonly>
            <button class="qty-btn" id="increase1" onclick="changeQuantity1(1)">+</button>
        </div>
    </div>

    <div class="section section-box shipping" onclick="openModal('shipping-modal')">üì¶ Th·ªùi gian nh·∫≠n h√†ng</div>
    <div class="section section-box description" onclick="openModal('desc-modal')">üßæ Th√¥ng s·ªë & m√¥ t·∫£</div>

    <div class="rating section-box">‚≠ê {{ product.rating | default(0) }} / 5 ({{ product.review_count | default(0) }} l∆∞·ª£t ƒë√°nh gi√°)</div>

    <div class="comments section-box">
        <h3>üí¨ B√¨nh lu·∫≠n c·ªßa kh√°ch h√†ng</h3>
        {% for c in product.comments | default([]) %}
            <div class="comment">
                <strong>{{ c.user | default('Kh√°ch') }}</strong>: {{ c.text | default('') }}
            </div>
        {% endfor %}
    </div>
</div>

<!-- Th√¥ng tin th·ªùi gian nh·∫≠n h√†ng -->
<div id="shipping-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('shipping-modal')">&times;</span>
        <h3>Th·ªùi gian nh·∫≠n h√†ng</h3>
        <p>{{ product.shipping_info | default('Ch∆∞a c√≥ th√¥ng tin') }}</p>
    </div>
</div>

<!-- Th√¥ng s·ªë s·∫£n ph·∫©m -->
<div id="desc-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('desc-modal')">&times;</span>
        <h3>Th√¥ng s·ªë s·∫£n ph·∫©m</h3>
        <p>{{ product.description | default('Ch∆∞a c√≥ th√¥ng tin') }}</p>
    </div>
</div>

<!-- n√∫t ƒë·∫∑t/th√™m h√†ng -->
<div class="action-row">
    <button id="add-cart" class="add-cart" onclick="addToCart()">Th√™m v√†o gi·ªè h√†ng</button>
    <button class="buy-now" onclick="openProductModal()">ƒê·∫∑t h√†ng</button>
</div>

<div class="product-modal" id="product-modal">
    <div class="modal-content">
        <span class="close" onclick="closeProductModal()">&times;</span>
        <div class="modal-top">
            <img id="modal-main-img" src="{{url_for('static', filename = product.HinhAnh)}}" alt="{{ product.name }}">
            <div class="price-stock">
                <p>Gi√°: {{ "{:,.0f}".format(product.Gia) }}‚Ç´</p>
                <p>S·ªë c√≤n trong kho: <span id="stock-count">{{ product.SoLuongcon }}</span></p>
            </div>
        </div>

        <div class="modal-section">
            <p>Ph√¢n lo·∫°i:</p>
            <!-- L·ª±a ch·ªçn m√†u s·∫Øc -->
            <div class="options color-options">
                <strong>M√†u s·∫Øc:</strong>
                {% for color in product.colors %}
                    <button class="option-btn" 
                            onclick="changeModalImage(`{{ url_for('static', filename=color.image) | default('default.png') }}`)">
                        {{ color.name | default('M√†u') }}
                    </button>
                {% endfor %}
            </div>
            <!-- L·ª±a ch·ªçn size -->
            <div class="options size-options">
                <strong>Size:</strong>
                {% for size in product.sizes | default([]) %}
                    <button class="option-btn">{{ size }}</button>
                {% endfor %}
            </div>
        </div>

        <div class="quantity-control">
            <span>S·ªë l∆∞·ª£ng:</span>
            <div>
                <button class="qty-btn" id="decrease" onclick="changeQuantity(-1)">-</button>
                <input type="text" id="quantity" value="1" readonly>
                <button class="qty-btn" id="increase" onclick="changeQuantity(1)">+</button>
            </div>
        </div>

        <div class="modal-footer">
            <button class="buy-now" id="modal-buy-now">ƒê·∫∑t h√†ng</button>
        </div>
    </div>
</div>

<!-- script cho cart -->
<script src="{{ url_for('static', filename='js/add-to-cart.js') }}"></script>

<!-- ·∫¢nh cho l√∫c ƒë·∫∑t/th√™m h√†ng -->
<script id="image-data" type="application/json">
    {{ product.images | default([]) | tojson }}
</script>

<script>
    const PRODUCT_ID = {{ product.MaSP | default(0) | tojson }};
    const maxStock = {{ product.SoLuongcon | default(10) | tojson }};
</script>

<script src="{{ url_for('static', filename='js/product_detail.js') }}"></script>
<script src="{{ url_for('static', filename='js/order_product.js') }}"></script>

<!-- Script b√¨nh lu·∫≠n & ƒë√°nh gi√° -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    const productId = "{{ product.MaSP }}";
    const reviewsRaw = localStorage.getItem('product_reviews');
    console.log("RAW product_reviews from localStorage:", reviewsRaw);  // ki·ªÉm tra d·ªØ li·ªáu
    const reviews = JSON.parse(reviewsRaw || '{}');

    console.log("productId:", productId);
    console.log("reviews keys:", Object.keys(reviews));

    if (reviews[productId]) {
        const data = reviews[productId];
        document.querySelector(".rating").innerHTML = `‚≠ê ${data.avg.toFixed(1)} / 5 (${data.count} l∆∞·ª£t ƒë√°nh gi√°)`;
        const commentContainer = document.querySelector(".comments");
        data.comments.forEach(c => {
            const div = document.createElement("div");
            div.className = "comment";
            const starsHTML = "‚òÖ".repeat(c.stars) + "‚òÜ".repeat(5 - c.stars);
            div.innerHTML = `
                <img src="/static/images/user.png" class="avatar">
                <div>
                    <div class="comment-stars">${starsHTML}</div>
                    <strong>${c.user}</strong>: ${c.text}
                </div>
            `;
            commentContainer.appendChild(div);
        });
    } else {
        console.log("Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m");
    }
});
</script>
<style>
.comment { display: flex; align-items: flex-start; margin-top: 10px; gap: 10px; }
.comment img.avatar { width: 35px; height: 35px; border-radius: 50%; }
.comment-stars { color: gold; font-size: 16px; line-height: 1; margin-bottom: 3px; }
</style>

</body>
</html>
