<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Đơn hàng của tôi</title>
<style>
    body { font-family: 'Roboto', sans-serif; padding: 20px; }
    .order-row { display: flex; align-items: center; border-bottom: 1px solid #ddd; padding: 15px 0; }
    .order-row img { height: 100px; width: 100px; margin-right: 20px; }
    .order-info { flex: 1; }
    .order-info div { margin-bottom: 5px; }
    .status { cursor: pointer; font-weight: bold; margin-right: 10px; }
    .status.green { color: green; }
    .status.yellow { color: goldenrod; }
    .cancel-btn { padding: 5px 10px; cursor: pointer; }
    .modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 50%; position: relative; }
    .close { color: #aaa; float: right; font-size: 28px; cursor: pointer; }
    .reasons { display: flex; flex-direction: column; margin: 15px 0; }
    .reason { display: flex; align-items: center; margin: 5px 0; cursor: pointer; }
    .circle { width: 20px; height: 20px; border: 2px solid #888; border-radius: 50%; margin-right: 10px; position: relative; }
    .circle.checked::after { content: ''; position: absolute; top: 3px; left: 3px; width: 10px; height: 10px; background-color: #555; border-radius: 50%; }
    .confirm-btn { position: absolute; right: 20px; bottom: 20px; padding: 5px 15px; cursor: pointer; }
    .error-msg { color: red; margin-top: 10px; }
    .success-msg { position: fixed; top: 50px; left: 50%; transform: translateX(-50%); background-color: #d4edda; color: #155724; padding: 10px 20px; border-radius: 5px; display: none; }
    .review-btn { padding: 5px 10px; cursor: pointer; background-color: #ffcc00; border: none; border-radius: 5px; }
    .stars { display: flex; justify-content: center; font-size: 30px; color: #555; cursor: pointer; }
    .star.active { color: gold; }
    textarea { resize: none; border-radius: 5px; padding: 8px; border: 1px solid #ccc; }
    .success-msg.review-success {
        background-color: #d4edda;
        color: #155724;
        padding: 10px 20px;
        border-radius: 5px;
        display: none;
        position: fixed;
        top: 60px;
        left: 50%;
        transform: translateX(-50%);
    }
</style>
</head>
<body>
<h1>Đơn hàng của tôi</h1>

<div id="orders-container">
    {% for order in orders %}
    <div class="order-row" id="order-{{ order.id }}">
        <img src="{{ url_for('static', filename=order.HinhAnh) }}" alt="{{ order.TenSP }}">
        <div class="order-info">
            <div><strong>{{ order.TenSP }}</strong></div>
            <div>Giá: {{ order.Gia }}₫</div>
            <div>Số lượng: {{ order.SoLuong }}</div>
        </div>
        <div>
            <span class="status {% if order.TrangThai == 'Đã giao thành công' %}green{% else %}yellow{% endif %}" onclick="openStatusModal({{ order.id }})">{{ order.TrangThai }}</span>
            {% if order.TrangThai == 'Chờ xác nhận đơn' %}
                <button class="cancel-btn" onclick="openCancelModal({{ order.id }})">Hủy đơn</button>
            {% elif order.TrangThai == 'Chờ bạn xác nhận' %}
                <button class="confirm-order-btn" onclick="confirmOrder({{ order.id }}, '{{ order.MaSP }}')">Xác nhận giao thành công</button>
            {% endif %}
            {% if order.TrangThai == 'Đã giao thành công' %}
            <button class="review-btn" onclick="openReviewModal({{ order.id }}, '{{ order.ProductID }}')">Đánh giá</button>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- Chi tiết các trạng thái của đơn -->
{% for order in orders %}
<div id="status-modal-{{ order.id }}" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('status', {{ order.id }})">&times;</span>
        <h2>Chi tiết trạng thái đơn hàng</h2>
        <p>Thông tin chi tiết sẽ hiển thị ở đây...</p>
    </div>
</div>
{% endfor %}

<!-- hủy đơn -->
{% for order in orders %}
<div id="cancel-modal-{{ order.id }}" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('cancel', {{ order.id }})">&times;</span>
        <h2>Chọn lý do hủy đơn</h2>
        <div class="reasons">
            <div class="reason" onclick="selectReason(this)"><div class="circle"></div>Cập nhật thông tin giao hàng</div>
            <div class="reason" onclick="selectReason(this)"><div class="circle"></div>Tôi muốn thay đổi size</div>
            <div class="reason" onclick="selectReason(this)"><div class="circle"></div>Khác</div>
        </div>
        <div class="error-msg" id="error-{{ order.id }}"></div>
        <button class="confirm-btn" onclick="confirmCancel({{ order.id }})">Xác nhận</button>
    </div>
</div>
{% endfor %}

<!-- Đánh giá  -->
{% for order in orders %}
<div id="review-modal-{{ order.id }}" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('review', {{ order.id }})">&times;</span>
        <h2>Đánh giá sản phẩm</h2>
        <div class="stars" id="stars-{{ order.id }}">
        {% for i in range(1, 6) %}
        <span class="star" data-value="{{ i }}">&#9733;</span>
        {% endfor %}
        </div>
        <textarea id="comment-{{ order.id }}" placeholder="Nhập bình luận của bạn..." rows="3" style="width:100%; margin-top:10px;"></textarea>
        <button class="confirm-btn" onclick="submitReview({{ order.id }}, '{{ order.MaSP }}')">Gửi</button>
    </div>
</div>
{% endfor %}

<div class="success-msg" id="success-msg">Bạn đã hủy đơn thành công</div>

<script>
function openStatusModal(id) {
    document.getElementById('status-modal-' + id).style.display = 'block';
}
function openCancelModal(id) {
    document.getElementById('cancel-modal-' + id).style.display = 'block';
}
function closeModal(type, id) {
    document.getElementById(type + '-modal-' + id).style.display = 'none';
}

function selectReason(el) {
    let circles = el.parentElement.querySelectorAll('.circle');
    circles.forEach(c => c.classList.remove('checked'));
    el.querySelector('.circle').classList.add('checked');
}
//Gọi API hủy đơn
function confirmCancel(orderId) {
    const modal = document.getElementById('cancel-modal-' + orderId);
    const selected = modal.querySelector('.circle.checked');
    const errorMsg = document.getElementById('error-' + orderId);

    if (!selected) {
        errorMsg.textContent = 'Vui lòng chọn lý do hủy đơn';
        return;
    }

    errorMsg.textContent = '';

    // Gửi yêu cầu lên server để cập nhật DB
    fetch("/cancel_order", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ order_id: orderId })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            modal.style.display = 'none';
            const orderRow = document.getElementById('order-' + orderId);
            orderRow.remove();

            const successMsg = document.getElementById('success-msg');
            successMsg.style.display = 'block';
            setTimeout(() => { successMsg.style.display = 'none'; }, 2000);
        } else {
            alert("Hủy đơn thất bại: " + data.message);
        }
    });
}

//Xác nhận giao thành công
function confirmOrder(orderId) {
    fetch("/confirm_order", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ order_id: orderId })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            // Cập nhật trạng thái thành "Đã giao thành công"
            const orderRow = document.getElementById('order-' + orderId);
            const statusSpan = orderRow.querySelector('.status');
            statusSpan.textContent = 'Đã giao thành công';
            statusSpan.classList.remove('yellow');
            statusSpan.classList.add('green');

            // Ẩn nút xác nhận đơn
            const confirmBtn = orderRow.querySelector('.confirm-order-btn');
            if (confirmBtn) confirmBtn.remove();

            // Nếu muốn, hiển thị nút đánh giá
            const reviewBtn = document.createElement('button');
            reviewBtn.className = 'review-btn';
            reviewBtn.textContent = 'Đánh giá';
            reviewBtn.onclick = function() {
                openReviewModal(orderId, productId);
            };
            orderRow.appendChild(reviewBtn);

        } else {
            alert("Xác nhận thất bại: " + data.message);
        }
    });
}

window.onclick = function(event) {
    {% for order in orders %}
    if (event.target == document.getElementById('status-modal-{{ order.id }}')) {
        document.getElementById('status-modal-{{ order.id }}').style.display = 'none';
    }
    if (event.target == document.getElementById('cancel-modal-{{ order.id }}')) {
        document.getElementById('cancel-modal-{{ order.id }}').style.display = 'none';
    }
    {% endfor %}
}

//script cập nhật bình luận và đánh giá
let starRatings = {};

function openReviewModal(id, productId) {
    const modal = document.getElementById('review-modal-' + id);
    modal.style.display = 'block';
    const stars = modal.querySelectorAll('.star');
    starRatings[id] = 1; 
    updateStarsDisplay(stars, 1);

    stars.forEach(star => {
        star.onclick = function() {
            const value = parseInt(this.getAttribute('data-value'));
            if (starRatings[id] === 5 && value === 5) {
                starRatings[id] = 1; 
            } else {
                starRatings[id] = value;
            }
            updateStarsDisplay(stars, starRatings[id]);
        };
    });
}

function updateStarsDisplay(stars, activeCount) {
    stars.forEach((star, index) => {
        if (index < activeCount) star.classList.add('active');
        else star.classList.remove('active');
    });
}

function submitReview(orderId, productId) {
    productId = productId.toString();
    const rating = starRatings[orderId] || 1;
    const comment = document.getElementById('comment-' + orderId).value.trim();
    let reviews = JSON.parse(localStorage.getItem('product_reviews') || '{}');
    if (!reviews[productId]) {
        reviews[productId] = { avg: 0, count: 0, comments: [] };
    }
    const r = reviews[productId];
    r.avg = ((r.avg * r.count) + rating) / (r.count + 1);
    r.count += 1;
    r.comments.push({ user: 'User', text: comment, stars: rating });
    localStorage.setItem('product_reviews', JSON.stringify(reviews));
    document.getElementById('review-modal-' + orderId).style.display = 'none';
    const successMsg = document.getElementById('success-msg');
    successMsg.textContent = 'Cảm ơn bạn đã phản hồi';
    successMsg.style.display = 'block';
    setTimeout(() => { successMsg.style.display = 'none'; }, 2000);
}
</script>
</body>
</html>
